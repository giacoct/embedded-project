<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Joystick 2D</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .joystick-container {
      position: relative;
      width: 200px;
      height: 200px;
      background: #222;
      border: 3px solid #555;
      border-radius: 17%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stick {
      position: absolute;
      width: 60px;
      height: 60px;
      background: #00bcd4;
      border-radius: 50%;
      transition: 0.05s;
      cursor: grab;
    }

    .coords {
      margin-top: 20px;
      font-size: 1.2em;
    }
  </style>
</head>

<body>

  <div class="joystick-container" id="joystick">
    <div class="stick" id="stick"></div>
  </div>
  <div class="coords" id="coords">X: 0, Y: 0</div>

  <script>
    let connection = new WebSocket("ws://192.168.137.233/ws");
    connection.onopen = function () {
      connection.send("Connect " + new Date());
    };
    connection.onerror = function (error) {
      console.log("WebSocket Error ", error);
      alert("WebSocket Error ", error);
    };
    connection.onmessage = function (e) {
      console.log("Received: ", e.data);
    };

  </script>
  <script>
    const joystick = document.getElementById('joystick');
    const stick = document.getElementById('stick');
    const coords = document.getElementById('coords');

    let vecchiX = 0;
    let vecchiY = 0;

    const maxRadius = 80; /* distanza massima dal centro*/
    const center = { x: 100, y: 100 }; /* centro del joystick*/
    let dragging = false;

    joystick.addEventListener('mousedown', () => dragging = true);
    document.addEventListener('mouseup', () => {
      dragging = false;
      stick.style.transform = `translate(0px, 0px)`;
      coords.textContent = `X: 0, Y: 0`;
      console.log(`X: 0, Y: 0`);
    });


    document.addEventListener('mousemove', (e) => {
      if (!dragging) return;

      const rect = joystick.getBoundingClientRect();
      const x = e.clientX - rect.left - center.x;
      const y = e.clientY - rect.top - center.y;

      /* const distance = Math.min(Math.sqrt(x*x + y*y), maxRadius);
       const angle = Math.atan2(y, x);
       const limitedX = Math.cos(angle) * distance;
       const limitedY = Math.sin(angle) * distance;*/

      let limitedX = Math.min(x, maxRadius);
      let limitedY = Math.min(y, maxRadius);
      limitedX = Math.max(limitedX, -maxRadius);
      limitedY = Math.max(limitedY, -maxRadius);

      stick.style.transform = `translate(${limitedX}px, ${limitedY}px)`;

      const normX = (+(limitedX / maxRadius).toFixed(1)) * 10;
      const normY = (-(limitedY / maxRadius).toFixed(1)) * 10;

      coords.textContent = `X: ${normX}, Y: ${normY}`;
      if (vecchiX != normX || vecchiY != normY) {
        vecchiX = normX;
        vecchiY = normY;
        console.log(`X: ${normX}, Y: ${normY}`);
        connection.send(`X${normX};Y${normY}`);
      }

    });
  </script>

</body>

</html>