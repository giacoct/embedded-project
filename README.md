# Embedded Software fo the IoT - project group 23 - SUNFLOWER
A solar tracking system using light-sensing logic to maximize energy harvesting. Controlled automatically measuring light, or manually through joystick or webapp.

Our code works as a finite state machine that is linked to a **manual**, **automatic** and **web-control** operating modes.
You can access the web-control mode via the wifi generated by the esp32: "SOLAR_MOBILE" (we reccommend changing the password in the code). Then, access the web-control page on the address: `192.168.4.1` by typing it into your browser.  
Here you can see that you can switch between modes with the toggle switch. You can also switch between modes by clicking the joystick.

The porpouse of the automatic mode is to get the best possible illumination on our panels.
You can customize the various parameters to modify how fast the motors move and how sensitive the sensors are.

<div style="width:70%; margin: auto;">

![Finite State Machine diagram](src/FSM.png)
</div>

**Project Members**: Matteo Zambon, Alessandro Weber, Giacomo Castellan.



## Requirements
You will need to download the following libraries:
- [AsyncTCP.h](https://github.com/ESP32Async/AsyncTCP)
- [ESPAsyncWebServer.h](https://github.com/ESP32Async/ESPAsyncWebServer)


### Bill of Materials
- 1 _ESP32 S3_ board
- 1 Positional servo motor
- 1 Continuous servo motor
- 1 Slip ring (8 wires)
- 1 Solar panel
- 4 Photoresistors
- 3D prited parts &rarr; [at this link](https://www.printables.com/model/1574943-sunflower-project)



## Instructions
- You just have to print your 3D model and assemble it (more instructions at the link above).
- Then connect the cables as seen in the electrical scheme below:
![wiring diagram](src/wiring-diagram.png)
- Set up your Arduino IDE by: 
  - Installing the esp32 board &rarr; [follow this guide](https://randomnerdtutorials.com/installing-the-esp32-board-in-arduino-ide-windows-instructions/).
  - Installing the additional libraries previously downloaded.
- Finally, upload the _esp32_solar_station_ code using your Arduino IDE.  
  ⚠️ Note that you should upload the sketch with the following parameters set on Arduino IDE:


### Arduino IDE Setup (tools)

> You should check the following setting with the ones provied by the manufacturer.

- Board: "ESP32S3 Dev Module"
- **USB CDC On Boot**: "Enabled"
- **CPU Frequency**: "240MHz (WiFi)"
- Core Debug Level: "None"
- USB DFU On Boot: "Disabled"
- Erase All Flash Before Sketch Upload: "Disabled"
- Events Run On: "Core 1"
- **Flash Mode**: "QIO 80MHz"
- **Flash Size**: "16MB (128Mb)"
- JTAG Adapter: "Disabled"
- Arduino Runs On: "Core 1"
- USB Firmware MSC On Boot: "Disabled"
- **Partition Scheme**: "Default 4MB with spiffs (1.2MB APP/1.5MB SPIFFS)"
- **PSRAM**: "OPI PSRAM"
- **Upload Mode**: "UART0 / Hardware CDC"
- Upload Speed: "921600"
- USB Mode: "Hardware CDC and JTAG"
- Zigbee Mode: "Disabled"



## Project Structure

```code
embedded-project
│   README.md
│   website.html
│   wiring-diagram.png
│
├───esp32_solar_station
│       esp32_solar_station.ino
│       lightControl.cpp
│       lightControl.h
│       motorController.cpp
│       motorController.h
│       website.cpp
│
└───testing
        PID tuning.py
        pid_constants.json
        ws_client - send noweb.py
        ws_client - test.js
        ws_server - echo.py
```


### Sources:
- ESP32-S3 documentation:
  - [ESP32-S3-DevKitC-1](https://docs.espressif.com/projects/esp-dev-kits/en/latest/esp32s3/esp32-s3-devkitc-1/user_guide_v1.1.html)
  - [ESP-IDF Programming Guide](https://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/get-started/index.html)
  - [Arduino ESP32](https://docs.espressif.com/projects/arduino-esp32/en/latest/index.html)
- Webserver & websocket for esp32: https://lastminuteengineers.com/esp32-websocket-tutorial/
- Esp32 PWM Basicis: https://lastminuteengineers.com/esp32-pwm-tutorial/
- ledc docs: https://espressif-docs.readthedocs-hosted.com/projects/arduino-esp32/en/latest/api/ledc.html#



### Who did what

| Giacomo                       | Matteo                        | Alessandro                    |
|:------------------------------|:------------------------------|:------------------------------|
| ESP code (libraries and main) | ESP code (libraries and main) | ESP code (libraries and main) |
| 3D model and printing         | HTML development              | HTML development              |
| Finite state machine          | Finite state machine          | Video                         |
| Video                         | Presentation                  | Electrical scheme             |


## Presentation
- [Video](https://youtu.be/n94C179-7IY)
- [Presentation](https://drive.google.com/file/d/1SDzr-Ak0xUK7H76m8eDZOuBcJwM7BU4j/view?usp=drive_link)
