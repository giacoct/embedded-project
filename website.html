<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Joystick 2D</title>
  <style>
    html,
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      touch-action: none;
    }

    .text {
      margin: 1em;
    }

    .joystick-container {
      position: relative;
      width: 200px;
      height: 200px;
      background: #222;
      border: 3px solid #555;
      border-radius: 17%;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
      user-select: none;
    }

    .stick {
      position: absolute;
      width: 60px;
      height: 60px;
      background: #00bcd4;
      border-radius: 50%;
      transition: 0.05s;
      cursor: grab;
    }

    /* switch styling */
    .switch {
      position: relative;
      display: flex;
      align-items: center;
      height: 40px;
      margin-top: 2em;
      margin-bottom: 2em;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: relative;
      cursor: pointer;
      background-color: #555;
      transition: 0.4s;
      border-radius: 30px;
      width: 250px;
      text-align: center;
      padding: 12px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 30px;
      width: 30px;
      left: 7px;
      bottom: 6px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #0a9d48;
    }

    input:checked+.slider:before {
      transform: translateX(229px);
    }
  </style>
</head>

<body>
  <!-- ws status -->
  <div class="text" id="ws_info">Connecting...</div>
  <!-- joystick -->
  <div class="joystick-container" id="joystick">
    <div class="stick" id="stick"></div>
  </div>
  <!-- coordinates -->
  <div class="text" id="coords">X: 0, Y: 0</div>
  <!-- web-control switch -->
  <label class="switch">
    <input type="checkbox" id="toggle-web" checked>
    <span class="slider">WEB CONTROL</span>
  </label>


  <!-- websocket init -->
  <script>
    const ws_info = document.getElementById('ws_info');

    let connection = new WebSocket("ws://127.0.0.1:81");    // 192.168.4.1/ws
    connection.onopen = function () {
      ws_info.textContent = "Connected!";
      ws_info.style.color = "#069c56";
      connection.send("Connected device " + new Date());
    };
    connection.onerror = function (error) {
      console.log("WebSocket Error ", error);
      ws_info.textContent = `WebSocket error`;
      ws_info.style.color = "#d3212c";
    };
    connection.onmessage = function (event) {
      const payload = event.data;
      if (payload == "#no-web#") {
        toggle_web.checked = false;
      }
    };
    connection.onclose = function (event) {
      console.log("WebSocket closed", event);
      ws_info.textContent = "Disconnected";
      ws_info.style.color = "#d3212c";
    };
  </script>

  <!-- toggle logic -->
  <script>
    const toggle_web = document.getElementById('toggle-web');
    toggle_web.checked = false;

    toggle_web.addEventListener('click', () => {
      if (connection.readyState != WebSocket.OPEN) {
        toggle_web.checked = false;
        return;
      }
      if (toggle_web.checked) {
        connection.send(`#control#`);
      } else {
        connection.send(`#toggle#`);
      }
    });

  </script>

  <!-- joystick & coordinates logic -->
  <script>
    const joystick = document.getElementById('joystick');
    const stick = document.getElementById('stick');
    const coords = document.getElementById('coords');

    const maxRadius = 80;
    const center = { x: 100, y: 100 };
    let dragging = false;
    let oldX = 0;
    let oldY = 0;

    joystick.addEventListener('pointerdown', () => dragging = true);

    document.addEventListener('pointerup', () => {
      dragging = false;
      stick.style.transform = `translate(0px, 0px)`;
      coords.textContent = `X: 0, Y: 0`;

      if (toggle_web.checked && connection.readyState === WebSocket.OPEN)
        connection.send(`#cord#X0;Y0`);
    });

    document.addEventListener('pointermove', (e) => {
      if (!toggle_web.checked) return;
      if (!dragging) return;

      const rect = joystick.getBoundingClientRect();
      const x = e.clientX - rect.left - center.x;
      const y = e.clientY - rect.top - center.y;

      let limitedX = Math.min(Math.max(x, -maxRadius), maxRadius);
      let limitedY = Math.min(Math.max(y, -maxRadius), maxRadius);

      stick.style.transform = `translate(${limitedX}px, ${limitedY}px)`;

      const normX = (+(limitedX / maxRadius).toFixed(1)) * 100;
      const normY = (-(limitedY / maxRadius).toFixed(1)) * 100;

      coords.textContent = `X: ${normX}, Y: ${normY}`;

      if ((oldX != normX || oldY != normY) && toggle_web.checked) {
        oldX = normX;
        oldY = normY;

        if (connection.readyState === WebSocket.OPEN)
          connection.send(`#cord#X${normX};Y${normY}`);
      }
    });
  </script>

</body>

</html>