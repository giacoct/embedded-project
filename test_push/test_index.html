<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Joystick ESP32 Y Fix</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #222;
      color: #ccc;
      font-family: sans-serif;
      flex-direction: column;
    }
    .joystick {
      position: relative;
      width: 200px;
      height: 200px;
      background: #444;
      border-radius: 50%;
      border: 2px solid #111;
      touch-action: none;
      overflow: hidden;
    }
    .stick {
      position: absolute;
      width: 80px;
      height: 80px;
      background: #777;
      border-radius: 50%;
      left: calc(50% - 40px);
      top: calc(50% - 40px);
      transition: transform 0.05s linear;
    }
    #coords {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
      background: #333;
      padding: 10px 20px;
      border-radius: 12px;
      border: 1px solid #555;
    }
  </style>
</head>
<body>
  <div class="joystick" id="joystick">
    <div class="stick" id="stick"></div>
  </div>
  <div id="coords">ΔX: 0.00 | ΔY: 0.00</div>

  <script>
    const joystick = document.getElementById('joystick');
    const stick = document.getElementById('stick');
    const coords = document.getElementById('coords');

    const maxRadius = joystick.offsetWidth / 2 - stick.offsetWidth / 2;
    const center = { x: joystick.offsetWidth / 2, y: joystick.offsetHeight / 2 };

    let dragging = false;

    const updatePosition = (x, y) => {
      const rect = joystick.getBoundingClientRect();
      const dx = x - rect.left - center.x;
      const dy = y - rect.top - center.y;

      const distance = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.atan2(dy, dx);

      const limitedDistance = Math.min(distance, maxRadius);
      const posX = limitedDistance * Math.cos(angle);
      const posY = limitedDistance * Math.sin(angle);

      stick.style.left = `calc(50% - 40px + ${posX}px)`;
      stick.style.top = `calc(50% - 40px + ${posY}px)`;

      // invertiamo la Y (sopra positivo, sotto negativo)
      const normX = +(posX / maxRadius).toFixed(2);
      const normY = +(-posY / maxRadius).toFixed(2);

      coords.textContent = `ΔX: ${normX} | ΔY: ${normY}`;
      console.log(`ΔX: ${normX}, ΔY: ${normY}`);
    };

    joystick.addEventListener('pointerdown', (e) => {
      dragging = true;
      updatePosition(e.clientX, e.clientY);
    });

    document.addEventListener('pointermove', (e) => {
      if (!dragging) return;
      updatePosition(e.clientX, e.clientY);
    });

    document.addEventListener('pointerup', () => {
      dragging = false;
      stick.style.left = 'calc(50% - 40px)';
      stick.style.top = 'calc(50% - 40px)';
      coords.textContent = 'ΔX: 0.00 | ΔY: 0.00';
      console.log('ΔX: 0.00, ΔY: 0.00');
    });
  </script>
</body>
</html>